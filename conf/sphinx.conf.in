source def_pqsql
{
    type = pgsql
    sql_host = pgcluster0t.bgdi.admin.ch
    sql_user = $PGUSER
    sql_pass = $PGPASS
    sql_port = 5432
    sql_query_pre = SET NAMES 'UTF8'
}

source src_swisssearch : def_pqsql
{
    sql_db = search
    sql_attr_bigint = id
    sql_attr_uint = rank
    sql_attr_string = label
    sql_attr_string = origin
    sql_attr_string = geom_st_box2d
    sql_field_string = detail
}

source src_address : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , strname1||' '||deinr||' <b>'||plz||' '||ort_27||'</b>' as label \
        , origin as origin \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'address'
}

source src_parcel : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , gemname||' '||name as label \
        , origin as origin \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'parcel'
}

source src_sn25 : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||name||'</b> ('||kanton||') - '||gemname as label \
        , origin as origin \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'sn25'
}

source src_gg25 : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||gemname||' ('||kanton||')</b>' as label \
        , origin as origin \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'gg25'
}

source src_kantone : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , remove_accents(search_name) as detail \
        , '<b>'||name||'</b>' as label \
        , origin as origin \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'kantone'
}

source src_district : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||name||'</b>' as label \
        , origin as origin \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'district'
}

source src_zipcode : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||plz||' - '||ort_27||' ('||kanton||')</b>' as label \
        , origin as origin \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'zipcode'
}

source layers : def_pqsql
{
    sql_db = bod
    sql_attr_bigint = id
    sql_attr_string = lang
    sql_attr_string = origin
    sql_attr_string = label
    sql_field_string = staging
    sql_field_string = topics
    sql_field_string = layer
    sql_field_string = detail
}

source src_layers_de : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'de' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_de
}

source src_layers_fr : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'fr' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_fr
}

source src_layers_en : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'en' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_en
}

source src_layers_it : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'it' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_it
}

source src_layers_rm : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'rm' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_rm
}

source src_ch_astra_ivs-nat : def_pqsql
{
    sql_db = uvek
    sql_query = \
        SELECT \
            nat_id::bigint as id \
            , ivs_nummer as label \
            , 'feature' as origin \
            , remove_accents(ivs_slaname)||' '||remove_accents(ivs_nummer)||' '||remove_accents(ivs_signatur) as detail \
            , 'ch.astra.ivs-nat' as layer \
            , quadindex(the_geom) as geom_quadindex \
            , y(st_transform(st_centroid(the_geom),4326)) as lat \
            , x(st_transform(st_centroid(the_geom),4326)) as lon \
            , st_box2d(the_geom) as geom_st_box2d   \
            , nat_id::bigint as id \
        from astra.ivs_nat
    sql_attr_bigint = id
    sql_attr_string = origin
    sql_attr_string = layer
    sql_attr_string = geom_st_box2d
    sql_attr_string = label
    sql_attr_float = lat
    sql_attr_float = lon
    sql_field_string = geom_quadindex
    sql_field_string = detail 
}

source src_ch_astra_ivs-reg_loc : def_pqsql
{
    sql_db = uvek
    sql_query = \
        SELECT reg_loc_id::bigint as id \
            , ivs_nummer as label \
            , 'feature' as origin \
            , remove_accents(ivs_slaname)||' '||remove_accents(ivs_nummer)||' '||remove_accents(ivs_signatur) as detail \
            , 'ch.astra.ivs-reg_loc' as layer \
            , quadindex(the_geom) as geom_quadindex \
            , y(st_transform(st_centroid(the_geom),4326)) as lat \
            , x(st_transform(st_centroid(the_geom),4326)) as lon \
            , st_box2d(the_geom) as geom_st_box2d \
            , reg_loc_id::bigint as id \
        from astra.ivs_reg_loc
    sql_attr_bigint = id
    sql_attr_string = origin
    sql_attr_string = layer
    sql_attr_string = label
    sql_attr_string = geom_st_box2d
    sql_attr_float = lat
    sql_attr_float = lon
    sql_field_string = geom_quadindex
    sql_field_string = detail
}


source src_ch_bfs_gebaeude_wohnungs_register : def_pqsql
{
    sql_db = search
    sql_query = \
        SELECT \
        gid as id \
        , strname1||' '||deinr||' <b>'||plz||' '||ort_27||'</b>' as label \
        , origin as origin \
        , 'ch.bfs.gebaeude_wohnungs_register' as layer \
        , quadindex(the_geom) as geom_quadindex \
        , y(st_transform(st_centroid(the_geom),4326)) as lat \
        , x(st_transform(st_centroid(the_geom),4326)) as lon \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'address'
    sql_attr_bigint = id
    sql_attr_uint = rank
    sql_attr_string = layer
    sql_attr_string = label
    sql_attr_string = origin
    sql_attr_string = geom_st_box2d
    sql_attr_float = lat
    sql_attr_float = lon
    sql_field_string = geom_quadindex
}



index zipcode
{
    source = src_zipcode
    path = /var/lib/sphinxsearch/data/index/zipcode
    type = plain
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 2
    infix_fields = detail
    enable_star = 1
}

index district : zipcode
{
    source = src_district
    path = /var/lib/sphinxsearch/data/index/district
}

index kantone : zipcode
{
    source = src_kantone
    path = /var/lib/sphinxsearch/data/index/kantone
}

index gg25 : zipcode
{
    source = src_gg25
    path = /var/lib/sphinxsearch/data/index/gg25
}

index sn25 : zipcode
{
    source = src_sn25
    path = /var/lib/sphinxsearch/data/index/sn25
}

index parcel : zipcode
{
    source = src_parcel
    path = /var/lib/sphinxsearch/data/index/parcel
}

index address : zipcode
{
    source = src_address
    path = /var/lib/sphinxsearch/data/index/address
}

index address_fuzzy : zipcode
{
    source = src_address
    path = /var/lib/sphinxsearch/data/index/address_fuzzy
    morphology = soundex, metaphone
}

index swisssearch
{
    type = distributed
    local = zipcode
    local = district
    local = kantone
    local = gg25
    local = sn25
    local = parcel
    local = address
}

index layers_de
{
    type = plain
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 2
    infix_fields = detail, layer, topics, staging
    source = src_layers_de
    path = /var/lib/sphinxsearch/data/index/layers_de
}

index layers_fr : layers_de
{
    source = src_layers_fr
    path = /var/lib/sphinxsearch/data/index/layers_fr
}

index layers_en : layers_de
{
    source = src_layers_en
    path = /var/lib/sphinxsearch/data/index/layers_en
}

index layers_it : layers_de
{
    source = src_layers_it
    path = /var/lib/sphinxsearch/data/index/layers_it
}

index layers_rm : layers_de
{
    source = src_layers_rm
    path = /var/lib/sphinxsearch/data/index/layers_rm
}

index ch_astra_ivs-nat
{
    type = plain
    source = src_ch_astra_ivs-nat
    path = /var/lib/sphinxsearch/data/index/ch_astra_ivs-nat
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 2
    infix_fields = detail
    min_prefix_len = 1
    prefix_fields = geom_quadindex
    enable_star = 1
}

index ch_astra_ivs-reg_loc
{
    type = plain # Which is also the default value
    source = src_ch_astra_ivs-reg_loc
    path = /var/lib/sphinxsearch/data/index/ch_astra_ivs-reg_loc
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 2
    infix_fields = detail
    min_prefix_len = 1
    prefix_fields = geom_quadindex
    enable_star = 1
}

index ch_bfs_gebaeude_wohnungs_register
{
    type = plain # Which is also the default value
    source = src_ch_bfs_gebaeude_wohnungs_register
    path = /var/lib/sphinxsearch/data/index/ch.bfs.gebaeude_wohnungs_register
    docinfo = extern
    charset_type = utf-8
    min_prefix_len = 1
    prefix_fields = geom_quadindex
    enable_star = 1
}


indexer
{
    mem_limit = 512M
    max_iosize = 1048576
}

searchd
{
    port = 9312
    log = /var/www/vhosts/service-sphinxsearch/logs/searchd.log
    query_log = /var/www/vhosts/service-sphinxsearch/logs/query.log
    pid_file = /var/run/sphinxsearch/searchd.pid
    dist_threads = 3
    read_timeout = 5
    max_children = 90
    max_matches = 10000
}
